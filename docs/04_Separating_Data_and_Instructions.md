# 第4章: データと指示の分離

このドキュメントは `Anthropic 1P/04_Separating_Data_and_Instructions.ipynb` の主要な概念を日本語で説明するものです。

## レッスン

多くの場合、完全なプロンプトを作成するのではなく、**後で追加の入力データで変更できるプロンプトテンプレート**を使用したいことがあります。これは、Claudeに毎回同じことをさせたいが、Claudeがタスクに使用するデータが毎回異なる場合に便利です。

幸いなことに、これはプロンプトの固定された骨組み（指示）を可変のユーザー入力（データ）から分離し、完全なプロンプトをClaudeに送信する前にユーザー入力をプロンプトに代入することで、非常に簡単に行うことができます。

### プロンプトテンプレートとは？

プロンプトテンプレートは、固定された指示部分と、後から具体的なデータで置き換えられるプレースホルダー（変数）部分から構成されるプロンプトの骨格です。

例：動物の鳴き声ジェネレーター
```python
# 可変コンテンツ
ANIMAL = "牛"

# 可変コンテンツのプレースホルダーを含むプロンプトテンプレート
PROMPT = f"動物の名前を教えます。その動物が出す鳴き声を教えてください。 {ANIMAL}"
```
この例では `{ANIMAL}` がプレースホルダーで、実行時には "牛" という具体的なデータに置き換えられます。

### なぜデータと指示を分離するのか？

- **繰り返しタスクの簡素化:** 同じ構造のプロンプトを異なるデータで何度も使用する場合に効率的です。
- **ユーザーの利便性:** エンドユーザーは、プロンプト全体の構造を意識することなく、必要なデータを提供するだけで済みます。
- **柔軟性:** f-stringや `format()` メソッドを使用して、複数の変数をプロンプトに組み込むことができます。

### 指示とデータを明確に区別する重要性

プロンプトテンプレートを使用する際、**Claudeがどこが指示で、どこが処理対象のデータなのかを明確に理解できるようにする**ことが非常に重要です。この区別が曖昧だと、Claudeは指示の一部をデータとして解釈したり、その逆を行ったりする可能性があります。

**問題の例：Eメールの書き換え**

テンプレートが不明確な場合：
```
EMAIL = "明日朝6時に来てください。私がCEOだからです。"
PROMPT = f"やあクロード。 {EMAIL} <----- このメールをもっと丁寧にして、他は何も変えないで。"
```
Claudeは "やあクロード" を書き換えるべきEメールの一部だと誤解し、「親愛なるクロード様」で始まる返答をするかもしれません。

### 推奨される解決策：XMLタグ

この問題を解決するためには、**入力をXMLタグで囲む**ことを推奨します。XMLタグは `<tag></tag>` のような山括弧タグです。開始タグ（例：`<tag>`）と、スラッシュでマークされた終了タグ（例：`</tag>`）のペアで構成されます。

例：Eメールの書き換え（XMLタグ使用）
```python
EMAIL = "明日朝6時に来てください。私がCEOだからです。"
PROMPT = f"やあクロード。 <email>{EMAIL}</email> <----- このメールをもっと丁寧にして、他は何も変えないで。"
```
`<email>` と `</email>` タグを使用することで、Claudeは書き換えるべきEメールの範囲を正確に認識します。

**XMLタグの利点：**
- Claudeは、プロンプトを整理するメカニズムとしてXMLタグを認識するように特別に訓練されています。
- `<document>`, `<data>`, `<text_to_analyze>` のように、内容に応じた明確なタグ名を使用することが推奨されます。
- 関数呼び出し以外では、パフォーマンスを最大限に高めるために使用すべき「特別な」XMLタグはありません。Claudeはこの点で非常に順応性があり、カスタマイズ可能です。

**別の例：リストの解釈**

XMLタグなし：
```
SENTENCES = """- 牛の鳴き声が好きです
- この文はクモに関するものです
- この文は犬に関するように見えるかもしれませんが、実際には豚に関するものです"""
PROMPT = f"""以下は文のリストです。リストの2番目の項目を教えてください。

- それぞれ動物に関するものです、例えばウサギのように。
{SENTENCES}"""
```
Claudeは `- それぞれ動物に関するものです、例えばウサギのように。` をユーザーが提供したリストの一部として誤って解釈する可能性があります。

XMLタグあり：
```python
SENTENCES = """- 牛の鳴き声が好きです
- この文はクモに関するものです
- この文は犬に関するように見えるかもしれませんが、実際には豚に関するものです"""
PROMPT = f"""以下は文のリストです。リストの2番目の項目を教えてください。

- それぞれ動物に関するものです、例えばウサギのように。
<sentences>
{SENTENCES}
</sentences>"""
```
`<sentences>` タグで囲むことで、Claudeはユーザー入力の文がどこから始まりどこで終わるかを正確に把握します。

### 細部への注意

プロンプトを作成する際には、**誤字脱字や文法的な誤りがないか確認する**ことが常に価値があります。Claudeはパターンに敏感であり（初期の頃、ファインチューニング前は生のテキスト予測ツールでした）、あなたが間違いを犯すと間違いを犯しやすく、あなたが賢く聞こえると賢く、あなたが愚かに聞こえると愚かになる、といった傾向があります。

## まとめ

この章では、プロンプトテンプレートを使用して指示とデータを分離するテクニックを学びました。特に、XMLタグを使用してデータ部分を明確に区切ることは、Claudeがタスクを正確に理解し、期待通りの結果を出すために非常に重要です。プロンプトの細部に注意を払うことも、Claudeのパフォーマンスを引き出す上で役立ちます。
