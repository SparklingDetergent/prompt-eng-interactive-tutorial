# 第5章: 出力フォーマットとClaudeのための発言（プリフィル）

このドキュメントは `Anthropic 1P/05_Formatting_Output_and_Speaking_for_Claude.ipynb` の主要な概念を日本語で説明するものです。

## レッスン

**Claudeは、その出力をさまざまな方法でフォーマットすることができます**。そうするように依頼するだけでよいのです！

これらの方法の一つは、XMLタグを使用して、他の余計なテキストから応答を分離することです。プロンプトをより明確にし、Claudeにとって解析しやすくするためにXMLタグを使用できることはすでに学びました。同様に、Claudeに**XMLタグを使用してその出力を人間にとってより明確で理解しやすくする**よう依頼することもできます。

### 例

**例1: XMLタグによる出力フォーマット**

第2章で解決した「詩の前置き問題」を覚えていますか？Claudeに前置きを完全にスキップするよう依頼することで解決しましたが、**Claudeに詩をXMLタグに入れるよう指示する**ことでも同様の結果を達成できます。

```python
# 可変コンテンツ
ANIMAL = "ウサギ"

# プロンプトテンプレート
PROMPT = f"{ANIMAL}についての俳句を書いてください。<haiku>タグで囲んでください。"

# Claudeの応答 (期待される形式)
# <haiku>
# [ウサギの俳句]
# </haiku>
```
このように出力をXMLタグで囲むことの利点は、エンドユーザーがXMLタグ間のコンテンツを抽出する簡単なプログラムを書くことで、**詩だけを確実に取得できる**点にあります。

**例2: 「Claudeのための発言」（プリフィル）**

このテクニックの拡張として、**最初のXMLタグを`assistant`ターンに置く**方法があります。`assistant`ターンにテキストを置くと、基本的にはClaudeがすでに何かを言ったと伝え、そこから続けていくよう指示することになります。このテクニックは「Claudeのために話す」または「Claudeの応答をプリフィルする」と呼ばれます。

Messages API呼び出しの際、`messages`配列に以下のように含めます：
```json
[
  {"role": "user", "content": "猫についての俳句を<haiku>タグで書いてください。"},
  {"role": "assistant", "content": "<haiku>"}
]
```
Claudeは `<haiku>` の直後から応答を続けます。

```python
# 可変コンテンツ
ANIMAL = "猫"
PROMPT = f"{ANIMAL}についての俳句を書いてください。<haiku>タグで囲んでください。"
# Claudeの応答のためのプリフィル
PREFILL = "<haiku>" # assistantターンにこれを設定

# get_completion(PROMPT, prefill=PREFILL) の呼び出し
```
Claudeは `<haiku>` の続きから俳句を生成し、通常は `</haiku>` で閉じます。

**例3: JSON出力の強制**

Claudeは `JSON` 形式での出力も得意です。JSON出力を（確定的ではないものの、それに近い形で）強制したい場合は、Claudeの応答を始め括弧 `{` でプリフィルすることもできます。

```python
# 可変コンテンツ
ANIMAL = "犬"
PROMPT = f"{ANIMAL}についての俳句を書いてください。キーを \"first_line\", \"second_line\", \"third_line\" としたJSON形式を使用してください。"
# Claudeの応答のためのプリフィル
PREFILL = "{" # assistantターンにこれを設定
```
これにより、ClaudeはJSONオブジェクトの生成を開始する可能性が非常に高くなります。

**例4: 複数の入力変数と出力フォーマットの組み合わせ**

XMLタグを使用して複数の入力変数を指定し、さら出力フォーマットも指定し、プリフィルも活用する複雑な例も可能です。

```python
# 入力変数1
EMAIL = "ザックさん、こんにちは。あなたが書くことになっていたプロンプトの簡単な更新をお願いします。"
# 入力変数2
ADJECTIVE = "古風な英語"

PROMPT = f"クロードさん。こちらがメールです: <email>{EMAIL}</email>。このメールをより{ADJECTIVE}風にしてください。新しいバージョンを<{ADJECTIVE}_email> XMLタグで記述してください。"
PREFILL = f"<{ADJECTIVE}_email>" # assistantターンにこれを設定
```

### ボーナスレッスン：`stop_sequences`パラメータ

API経由でClaudeを呼び出す場合、終了XMLタグ（例: `</haiku>`）を `stop_sequences` パラメータに渡すことで、Claudeが目的のタグを出力した時点でサンプリングを停止させることができます。これにより、関心のある回答をすでに得た後のClaudeの結論的な発言を排除することで、コストと最終トークンまでの時間を節約できます。

## まとめ

この章では、Claudeの出力形式を制御するための強力なテクニックを学びました。
- **XMLタグを指定して出力を構造化する**ことで、後続の処理が容易になります。
- **「Claudeのための発言」（プリフィル）** を使用して、`assistant`ターンに開始タグや始め括弧を挿入することで、Claudeの応答形式を強く誘導できます（例：XML、JSON）。
- これらのテクニックは、プロンプトテンプレートや複数の変数と組み合わせることができ、複雑なタスクにも対応可能です。
- APIの `stop_sequences` パラメータを利用して、特定のタグで生成を停止させることで、効率化とコスト削減が期待できます。
