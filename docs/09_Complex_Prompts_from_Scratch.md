# 第9章: 複雑なプロンプトをゼロから作成する

このドキュメントは `Anthropic 1P/09_Complex_Prompts_from_Scratch.ipynb` の主要な概念を日本語で説明するものです。

## レッスン

これまでの章で学んだ様々なプロンプトエンジニアリングのテクニックを組み合わせて、ユニークで複雑なプロンプトを作成する方法を学びます。

以下は、複雑なプロンプトを作成するための推奨されるガイド付き構造です。この章の後半では、業界特有のプロンプトをいくつか紹介し、それらのプロンプトが同様に構造化されていることを説明します。

**注：** **すべてのプロンプトが以下の複雑な構造のすべての要素を必要とするわけではありません。** 要素を含めたり除外したりして、それがClaudeの応答にどのように影響するかを試してみることをお勧めします。通常は、**まず多くのプロンプト要素を使用してプロンプトを機能させ、その後でプロンプトを改良してスリム化する**のが最善です。

### 複雑なプロンプトの推奨構造要素

以下の要素と順序は、効果的な複雑なプロンプトを作成するための良い出発点となります。

1.  **タスクコンテキスト（役割設定）:** (ノートブック要素2)
    - Claudeがどのような役割を担うべきか、またはプロンプトで達成したい目標や包括的なタスクは何かについてコンテキストを与えます。
    - プロンプト本文の早い段階でコンテキストを設定するのが最善です。
    - 例：「あなたはAdAstra Careers社によって作成されたAIキャリアコーチのジョーとして行動します。あなたの目標はユーザーにキャリアアドバイスをすることです。」

2.  **トーンコンテキスト:** (ノートブック要素3)
    - インタラクションにとって重要であれば、Claudeが使用すべきトーンを指示します。
    - タスクによってはこの要素は必要ないかもしれません。
    - 例：「フレンドリーなカスタマーサービスのトーンを維持してください。」

3.  **詳細なタスク説明とルール:** (ノートブック要素4)
    - Claudeに実行させたい特定のタスクや、Claudeが従うべきルールについて詳しく説明します。
    - ここでは、答えがない場合や知らない場合にClaudeに「逃げ道」を与えることもできます。
    - この説明とルールを友人に示して、論理的に構成されており、曖昧な言葉が明確に定義されていることを確認するのが理想的です。
    - 例：「インタラクションに関する重要なルールは次のとおりです： - 常にAdAstra CareersのAIであるジョーとしてキャラクターを保つこと - 応答方法がわからない場合は、「申し訳ありません、理解できませんでした。質問を言い換えていただけますか？」と言うこと」

4.  **例（フューショットプロンプティング）:** (ノートブック要素5)
    - Claudeが模倣できる理想的な応答の例を少なくとも1つ提供します。これを`<example></example>` XMLタグで囲みます。複数の例を提供しても構いません。
    - 複数の例を提供する場合は、それが何の例であるかについてClaudeにコンテキストを与え、各例を独自のXMLタグセットで囲みます。
    - 例は、知識作業においてClaudeを望み通りに動作させるための最も効果的なツールの一つです。
    - 一般的には例が多いほど良いです。
    - 例：「標準的なインタラクションでの応答方法の例を次に示します：<example>\n顧客：こんにちは、あなたはどのように作成され、何をしていますか？\nジョー：こんにちは！私の名前はジョーです。AdAstra Careersによってキャリアアドバイスをするために作成されました。今日は何をお手伝いできますか？\n</example>」

5.  **処理する入力データ:** (ノートブック要素6)
    - Claudeがプロンプト内で処理する必要があるデータがある場合は、関連するXMLタグ内にここ（または他の適切な場所）に含めます。
    - 複数のデータを含めても構いませんが、それぞれを独自のXMLタグセットで囲むようにしてください。
    - この要素はタスクによっては必要ないかもしれません。順序も柔軟です。
    - 例：「<history>\n{会話履歴}\n</history>\n<question>\n{ユーザーの質問}\n</question>」

6.  **直近のタスク説明または要求:** (ノートブック要素7)
    - Claudeにプロンプトのタスクを遂行するために直ちに何をすべきかを「思い出させる」か、正確に伝えます。
    - 長いプロンプトの終わりに向けてこれを行うのが最善です。プロンプトの最初にこれを置くよりも良い結果が得られます。
    - ユーザーのクエリをプロンプトの最後に近づけることも一般的に良い習慣です。
    - 例：「ユーザーの質問にどのように応答しますか？」

7.  **予知（ステップバイステップ思考）:** (ノートブック要素8)
    - 複数のステップがあるタスクの場合、回答する前にステップバイステップで考えるようにClaudeに指示するのが良いでしょう。
    - 長いプロンプトの終わりに向けて、最終的な即時タスク要求または説明の直後に行うのが最善です。
    - 例：「応答する前に、まずあなたの答えについて考えてください。」

8.  **出力フォーマット:** (ノートブック要素9)
    - Claudeの応答を特定の方法でフォーマットしたい場合は、そのフォーマットが何であるかを明確にClaudeに伝えます。
    - プロンプトの終わりに向けてこれを置くのが、最初よりも良いです。
    - 例：「応答を<response></response>タグに入れてください。」

9.  **Claudeの応答のプリフィル（もしあれば）:** (ノートブック要素10)
    - Claudeの行動や応答を誘導するために、いくつかのプリフィルされた単語でClaudeの回答を開始するスペース。
    - これを行う場合、API呼び出しの`assistant`ロールにこれを設定する必要があります。
    - 例：「[ジョー] <response>」

**(API呼び出しの最初のメッセージは常に`user`ロールである必要があります。ノートブックの`get_completion()`関数はこれを自動的に行います。)**

### 適用例

1.  **キャリアコーチチャットボット:**
    - 上記の全要素（役割、トーン、ルール、会話履歴の処理、ユーザーの質問への応答、段階的思考、特定の出力形式、応答のプリフィル）を組み合わせて、特定のペルソナを持つ対話型エージェントを作成します。

2.  **リーガルサービスボット:**
    - 同様の構造を法的ユースケース（法的文書の分析、情報源の引用）に適用します。この例では、柔軟性を示すためにいくつかの要素の順序が変更されています。特に、回答前に文書から関連する引用を抽出する「予知（ステップバイステップ思考）」と、特定の引用形式が強調されています。

### 反復的なプロセスと実験の重要性
プロンプトエンジニアリングは、特に複雑なプロンプトの場合、厳密な手順に従うというよりも、科学的な試行錯誤のプロセスです。
- **まず多くの要素を使って機能させる:** 最初は包括的なプロンプトを作成し、期待通りに動作することを確認します。
- **改良とスリム化:** その後、不要な要素を削除したり、表現を簡潔にしたりして、プロンプトを洗練させます。
- **順序の柔軟性:** いくつかの要素（例：入力データ、例）の順序は比較的柔軟ですが、タスクコンテキストは早めに、即時タスクや出力フォーマットは遅めに配置するのが一般的です。
- **テストケース:** 様々な入力や状況に対応できるかテストするために、具体的なテストケースを準備することが重要です。

## まとめ
この最終章では、これまでに学んだ個々のプロンプトエンジニアリング技術を統合し、複雑なタスクに対応するための構造化されたプロンプトを構築する方法を学びました。提案された10個の要素（タスクコンテキスト、トーン、ルール、例、入力データ、即時タスク、予知、出力フォーマット、プリフィルなど）を組み合わせ、状況に応じて調整し、反復的なテストと改良を行うことで、Claudeの能力を最大限に引き出すことができます。プロンプトエンジニアリングは実験的な分野であり、ここで学んだ原則を基に、独自の最適なプロンプトを見つけ出すことが奨励されます。
