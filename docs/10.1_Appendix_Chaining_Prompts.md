# 付録10.1: プロンプトの連鎖（チェイニング）

このドキュメントは `Anthropic 1P/10.1_Appendix_Chaining Prompts.ipynb` の主要な概念を日本語で説明するものです。

## レッスン

「書くことは書き直すことである」ということわざがあります。実際、**Claudeにそう依頼すると、応答の精度を向上させることができる**場合がよくあります！

Claudeに「もう一度考える」よう促す方法はたくさんあります。人間に自分の仕事を見直すよう依頼する自然な方法は、一般的にClaudeにも有効です。（プロンプト連鎖の使用時期と方法のさらなる例については、[プロンプト連鎖のドキュメンテーション](https://docs.anthropic.com/claude/docs/chain-prompts)をご覧ください。）

プロンプトの連鎖とは、一連のプロンプト（指示）を使用し、あるプロンプトのClaudeによる出力を次のプロンプトの入力の一部として使用するテクニックです。これにより、対話を通じて段階的に回答を精密化したり、複雑なタスクを複数のステップに分割したりすることができます。Messages APIでは、これまでの会話の履歴（ユーザーとアシスタントの交互のターン）を`messages`配列に含めることで自然に実現されます。

### 例

**例1: 単語リストの誤り訂正**

最初のプロンプトで、Claudeに特定の文字列で終わる単語を10個挙げさせます。しかし、その中には実際の単語ではないものが含まれている可能性があります。

最初のプロンプト (`first_user`):
```
「ab」という正確な文字で終わる単語を10個挙げてください。
```
Claudeの最初の応答 (`first_response`):
```
「ab」で終わる10個の単語はこちらです：
1. Cab
2. Dab
3. Gab
4. Jab
5. Lab
6. Nab
7. Slab
8. Tab
9. Blab
10. Vocab (←これは実際の英単語だが、"vocab"は"vocabulary"の短縮形であり、文脈によっては不適切かもしれない。より明確な例として、もしClaudeが "flabbergab" のような存在しない単語を生成した場合を想定)
```

次に、**Claudeに回答をより正確にするよう依頼する**ことで、エラーを修正します。Claudeの誤った応答（`first_response`）を会話履歴の一部として含め、前の回答を修正するよう依頼する別のターンを追加します。

2番目のプロンプト (`second_user`):
```
実際の単語ではない「単語」をすべて置き換えてください。
```
会話の履歴 (`messages`配列):
```json
[
  {"role": "user", "content": "「ab」という正確な文字で終わる単語を10個挙げてください。"},
  {"role": "assistant", "content": "「ab」で終わる10個の単語はこちらです：\n1. Cab\n2. Dab\n3. Gab\n4. Jab\n5. Lab\n6. Nab\n7. Slab\n8. Tab\n9. Blab\n10. Vocab"},
  {"role": "user", "content": "実際の単語ではない「単語」をすべて置き換えてください。"}
]
```
Claudeは、2番目のユーザープロンプトに基づいて、リスト内の非実在単語を修正しようとします。

**注意点：** Claudeが既に正しい回答をしていた場合に不必要に変更を加えないように、「逃げ道を与える」（第8章参照）ことが重要です。
例えば、2番目のプロンプトを次のように変更します：
```
実際の単語ではない「単語」をすべて置き換えてください。すべての単語が実際の単語である場合は、元のリストを返してください。
```
これにより、Claudeはリストが既に正しければ、それを維持する可能性が高くなります。

**例2: ストーリーの改善**

プロンプトの連鎖を使用して、Claudeに応答を「より良くする」よう依頼することもできます。まず、Claudeに最初のバージョンのストーリーを生成させます。

最初のプロンプト (`first_user`):
```
走るのが好きな女の子についての3文の短い物語を書いてください。
```
Claudeの最初の応答 (`first_response`): (3文の短い物語)

次に、Claudeに最初の草稿を改善させます。

2番目のプロンプト (`second_user`):
```
物語をもっと良くしてください。
```
会話の履歴には、最初のユーザープロンプトとClaudeの最初の物語が含まれます。Claudeは、この2番目の指示に基づいて、より詳細で魅力的な物語を生成しようとします。

**例3: 複数ステップのタスク（名前の抽出とアルファベット順整列）**

この形式の置き換えは非常に強力です。あるClaudeの呼び出しの結果を取得し、それを別の、より長い呼び出しにプラグインすることができます。これは「関数呼び出し」と呼ばれるものを行うために使用でき、Claudeに何らかの関数を実行するよう依頼し、その関数の結果を取得して、その結果でさらに何かを行うようClaudeに依頼します。

最初のプロンプト（今回はClaudeの応答をプリフィルします）：
```
first_user = """以下のテキストからすべての名前を見つけてください：

「ねえ、ジェシー。私だよ、エリン。ジョーイが明日開くパーティーのことで電話してるんだ。キーシャも来ると言っていたし、メルも来ると思うよ。」"""
prefill = "<names>"
```
Claudeの最初の応答 (`first_response`、プリフィルを含む）：
```
<names>
ジェシー
エリン
ジョーイ
キーシャ
メル
</names>
```

次に、この名前のリストを別のプロンプトに渡します。

2番目のプロンプト (`second_user`):
```
リストをアルファベット順に並べてください。
```
会話の履歴には、最初のユーザープロンプト、プリフィルを含むClaudeの応答全体、そしてこの2番目のユーザープロンプトが含まれます。Claudeは名前のリストをアルファベット順に並べ替えます。

## まとめ
プロンプトの連鎖は、Claudeの初期応答を反復的に改善したり、複雑なタスクを管理しやすいステップに分解したりするための強力なテクニックです。
- **誤り訂正:** Claudeに自己修正を促します。
- **品質向上:** 生成されたコンテンツ（物語、要約など）を洗練させます。
- **段階的処理:** あるプロンプトの出力を次のプロンプトの入力として使用し、複数ステップのタスクを実行します。
これは、Messages APIの会話履歴機能を通じて自然に実装できます。次の付録では、この概念をさらに発展させた関数呼び出しについて学びます。
